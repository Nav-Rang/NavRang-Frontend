<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavRang | Checkout</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dm26lxw7u/image/upload/v1751883905/NavRang_zzk8rf.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="userDetials.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="logo">NavRang</a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container" id="checkout-page">
        <div class="checkout-grid">
            <div class="checkout-details-column">
                <h1 class="section-title">Checkout</h1>

                <div class="profile-card">
                    <div class="profile-header">
                        <img class="profile-avatar" src="https://res.cloudinary.com/dm26lxw7u/image/upload/v1751883906/profile-pic_lm2g3t.png" alt="User Avatar">
                        <div class="profile-details">
                            <p id="userNameDisplay">Guest User</p>
                            <p id="userEmailDisplay">guest@example.com</p>
                        </div>
                    </div>
                </div>

                <div class="card address-section-container">
                    <h2>Delivery Address</h2>
                    <div id="savedAddress" class="saved-address">
                        <p id="addressName">Loading...</p>
                        <p id="addressDetails"></p>
                        <p id="addressCityStatePin"></p>
                        <p id="addressNearTo"></p>
                    </div>
                    <button id="changeAddressBtn" class="auth-button" style="margin-top: 1rem;">Change Address</button>
                    
                    <form id="addressForm" class="address-form" style="display:none; margin-top: 20px;">
                        <div class="form-group">
                            <label for="building">Building/House No.</label>
                            <input type="text" id="building" class="form-input" placeholder="Flat, House no., Building" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Street/Colony</label>
                            <input type="text" id="address" class="form-input" placeholder="Area, Colony, Street, Sector" required>
                        </div>
                        <div class="form-group">
                            <label for="nearTo">Landmark</label>
                            <input type="text" id="nearTo" class="form-input" placeholder="E.g., Near Apollo Hospital">
                        </div>
                        <div class="form-group">
                            <label for="pinCode">Pincode</label>
                            <input type="text" id="pinCode" class="form-input" placeholder="Enter Pincode" required>
                        </div>
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" class="form-input" placeholder="City" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" class="form-input" placeholder="State" required>
                        </div>
                        <button type="submit" class="auth-button">Save Address</button>
                    </form>
                </div>
            </div>

            <div class="order-summary-column">
                <div class="cart-summary">
                    <h2>Order Summary</h2>
                    <div id="orderSummaryItems">
                        </div>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotalAmount">₹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping:</span>
                        <span>₹50.00</span> </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="totalAmount">₹0.00</span>
                    </div>

                    <div class="payment-options" style="margin-top: 30px;">
                        <h3>Choose Payment Method:</h3>
                        <button id="codButton" class="auth-button" style="margin-bottom: 10px;">Cash on Delivery</button>
                        <button id="razorpayButton" class="auth-button">Pay with Razorpay</button>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                 <div class="footer-section">
                    <h3>NavRang</h3>
                    <p>Your Divine Shopping Destination.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="cart.html">Cart</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p>Email: info@navrang.com</p>
                    <p>Phone: +91 98765 43210</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 NavRang. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        const backendUrl = 'https://navrang-backend.onrender.com/api';

        document.addEventListener('DOMContentLoaded', () => {
            const userLoggedIn = localStorage.getItem('userLoggedIn');
            if (userLoggedIn !== 'true') {
                showNotification('Please log in to proceed with checkout.', 'error');
                setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                return;
            }

            loadUserDetails();
            loadAddressDetails();
            renderOrderSummary();

            document.getElementById('changeAddressBtn').addEventListener('click', () => {
                const form = document.getElementById('addressForm');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
                document.getElementById('changeAddressBtn').textContent = form.style.display === 'none' ? 'Change Address' : 'Hide Address Form';
            });

            document.getElementById('addressForm').addEventListener('submit', handleSaveAddress);

            // Payment button listeners
            document.getElementById('codButton').addEventListener('click', handleCashOnDelivery);
            document.getElementById('razorpayButton').addEventListener('click', handleRazorpayPayment);
        });

        async function loadUserDetails() {
            const userName = localStorage.getItem('userName') || 'Guest';
            const userEmail = localStorage.getItem('userEmail') || 'guest@example.com';
            document.getElementById('userNameDisplay').textContent = userName;
            document.getElementById('userEmailDisplay').textContent = userEmail;
        }

        async function loadAddressDetails() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                showNotification('Authentication token not found. Please log in.', 'error');
                return;
            }

            try {
                const response = await axios.get(`${backendUrl}/get-user-details`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = response.data.user; // Assuming user object is directly in data
                if (user && user.address) {
                    const address = user.address;
                    document.getElementById('addressName').textContent = user.name || 'User';
                    document.getElementById('addressDetails').textContent = `${address.building}, ${address.address}`;
                    document.getElementById('addressCityStatePin').textContent = `${address.city}, ${address.state} - ${address.pinCode}`;
                    document.getElementById('addressNearTo').textContent = address.nearTo ? `Landmark: ${address.nearTo}` : '';

                    // Pre-fill form for editing
                    document.getElementById('building').value = address.building || '';
                    document.getElementById('address').value = address.address || '';
                    document.getElementById('nearTo').value = address.nearTo || '';
                    document.getElementById('pinCode').value = address.pinCode || '';
                    document.getElementById('city').value = address.city || '';
                    document.getElementById('state').value = address.state || '';
                } else {
                    document.getElementById('savedAddress').innerHTML = '<p>No address saved. Please add one.</p>';
                    document.getElementById('addressForm').style.display = 'block'; // Show form if no address
                }
            } catch (error) {
                console.error('Error fetching address details:', error);
                document.getElementById('savedAddress').innerHTML = '<p>Failed to load address. Please add one.</p>';
                document.getElementById('addressForm').style.display = 'block'; // Show form on error
                showNotification(error.response?.data?.message || 'Failed to fetch address.', 'error');
            }
        }

        async function handleSaveAddress(event) {
            event.preventDefault();
            const token = localStorage.getItem('authToken');
            const button = event.target.querySelector('button[type="submit"]');

            const addressData = {
                building: document.getElementById('building').value,
                address: document.getElementById('address').value,
                nearTo: document.getElementById('nearTo').value,
                pinCode: document.getElementById('pinCode').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value
            };

            setLoadingState(button, true, 'Saving...');
            try {
                const response = await axios.patch(`${backendUrl}/update-address`, addressData, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showNotification(response.data.message || 'Address updated successfully!', 'success');
                document.getElementById('addressForm').style.display = 'none'; // Hide form after saving
                loadAddressDetails(); // Reload to display new address
            } catch (error) {
                console.error('Error saving address:', error);
                showNotification(error.response?.data?.message || 'Failed to save address.', 'error');
            } finally {
                setLoadingState(button, false, 'Save Address');
            }
        }

        function renderOrderSummary() {
            let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            const orderSummaryItemsDiv = document.getElementById('orderSummaryItems');
            orderSummaryItemsDiv.innerHTML = '';
            let subtotal = 0;

            if (cartItems.length === 0) {
                orderSummaryItemsDiv.innerHTML = '<p>Your cart is empty.</p>';
                document.getElementById('totalAmount').textContent = '₹0.00';
                document.getElementById('subtotalAmount').textContent = '₹0.00';
                return;
            }

            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'summary-row';
                itemDiv.innerHTML = `
                    <span>${item.name} (x${item.quantity})</span>
                    <span>₹${itemTotal.toFixed(2)}</span>
                `;
                orderSummaryItemsDiv.appendChild(itemDiv);
            });

            const shippingCost = 50; // Example shipping
            const total = subtotal + shippingCost;

            document.getElementById('subtotalAmount').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `₹${total.toFixed(2)}`;
        }

        async function handleCashOnDelivery() {
            const codButton = document.getElementById('codButton');
            setLoadingState(codButton, true, 'Placing Order...');
            try {
                const token = localStorage.getItem('authToken');
                const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
                
                if (cartItems.length === 0) {
                    showNotification('Your cart is empty. Please add items before placing an order.', 'error');
                    setLoadingState(codButton, false, 'Cash on Delivery');
                    return;
                }

                const productDetails = cartItems.map(item => ({
                    productId: item.id, // Assuming item.id is the productId for your backend
                    quantity: item.quantity
                }));

                const response = await axios.post(`${backendUrl}/create-order`, {
                    productDetails: productDetails,
                    isCOD: true
                }, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                showNotification(response.data.message || 'COD Order Placed Successfully! Check your email for confirmation. 📦', 'success');
                localStorage.removeItem('cartItems'); // Clear cart
                setTimeout(() => { window.location.href = 'index.html'; }, 2000); // Redirect to home or confirmation page

            } catch (error) {
                console.error('COD Order Error:', error);
                showNotification(error.response?.data?.error || 'Failed to place COD order. Please ensure your address is saved.', 'error');
            } finally {
                setLoadingState(codButton, false, 'Cash on Delivery');
            }
        }

        async function handleRazorpayPayment() {
            const razorpayButton = document.getElementById('razorpayButton');
            setLoadingState(razorpayButton, true, 'Initiating Payment...');

            try {
                const token = localStorage.getItem('authToken');
                const userEmail = localStorage.getItem('userEmail');
                const userName = localStorage.getItem('userName');
                const totalAmountText = document.getElementById('totalAmount').textContent;
                const totalAmount = parseFloat(totalAmountText.replace(/[^\d.]/g, '')); // Extract number from "₹1500.00"

                if (!userEmail || !userName) {
                    showNotification('User details not found. Please log in again.', 'error');
                    setLoadingState(razorpayButton, false, 'Pay with Razorpay');
                    return;
                }
                
                const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
                if (cartItems.length === 0) {
                    showNotification('Your cart is empty. Please add items before proceeding to payment.', 'error');
                    setLoadingState(razorpayButton, false, 'Pay with Razorpay');
                    return;
                }

                const productDetails = cartItems.map(item => ({
                    productId: item.id,
                    quantity: item.quantity
                }));

                // Step 1: Create an order on your backend which will interact with Razorpay API
                const orderResponse = await axios.post(`${backendUrl}/create-order`, {
                    productDetails: productDetails,
                    isCOD: false // Indicate it's not a COD order
                }, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const { razorpayOrder, orderId } = orderResponse.data; // Backend sends razorpayOrder object and your internal orderId

                if (!razorpayOrder || !razorpayOrder.id || !razorpayOrder.currency || !razorpayOrder.amount) {
                    throw new Error("Missing Razorpay order details from backend response.");
                }

                // Step 2: Configure Razorpay Checkout
                var options = {
                    "key": "YOUR_RAZORPAY_KEY_ID", // Replace with your actual Razorpay Key ID
                    "amount": razorpayOrder.amount, // Amount is in paisa
                    "currency": razorpayOrder.currency,
                    "name": "NavRang",
                    "description": "Purchase from NavRang",
                    "image": "https://res.cloudinary.com/dm26lxw7u/image/upload/v1751883905/NavRang_zzk8rf.png", // Your company logo
                    "order_id": razorpayOrder.id, // Razorpay Order ID from backend
                    "handler": async function (response) {
                        setLoadingState(razorpayButton, true, 'Verifying Payment...');
                        try {
                            // Step 3: Verify the payment on your backend
                            const verificationResponse = await axios.post(`${backendUrl}/verify-payment`, {
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature,
                                orderId: orderId // Your internal order ID
                            }, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            showNotification(verificationResponse.data.msg || 'Payment successful! Order Placed. ✅', 'success');
                            localStorage.removeItem('cartItems'); // Clear cart
                            setTimeout(() => { window.location.href = 'index.html'; }, 2000); // Redirect to success page

                        } catch (verifyError) {
                            console.error('Razorpay Verification Error:', verifyError);
                            showNotification(verifyError.response?.data?.error || 'Payment verification failed. Please contact support.', 'error');
                        } finally {
                            setLoadingState(razorpayButton, false, 'Pay with Razorpay');
                        }
                    },
                    "prefill": {
                        "name": userName,
                        "email": userEmail,
                        "contact": "" // Optional: User's phone number if available
                    },
                    "notes": {
                        "address": "NavRang Shopping"
                    },
                    "theme": {
                        "color": "#6a0dad" // Your theme color (Day9 purple)
                    }
                };

                var rzp = new Razorpay(options);
                rzp.on('payment.failed', function (response){
                    showNotification(`Payment failed: ${response.error.description}. Please try again.`, 'error');
                    console.error('Razorpay Payment Failed:', response.error);
                    setLoadingState(razorpayButton, false, 'Pay with Razorpay');
                });

                rzp.open(); // Open Razorpay checkout form

            } catch (error) {
                console.error('Razorpay Order Creation Error:', error);
                showNotification(error.response?.data?.error || 'Failed to initiate Razorpay payment.', 'error');
            } finally {
                setLoadingState(razorpayButton, false, 'Pay with Razorpay');
            }
        }


        // --- UTILITY FUNCTIONS ---
        function setLoadingState(button, isLoading, loadingText) {
            if (button) {
                button.disabled = isLoading;
                button.innerHTML = isLoading ? `<span class="spinner"></span> ${loadingText}` : button.textContent;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.classList.add('show'); }, 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>