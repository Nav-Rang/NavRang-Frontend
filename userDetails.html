<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavRang | Checkout</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dm26lxw7u/image/upload/v1751883905/NavRang_zzk8rf.png">
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="style.css">
    <!-- Page-specific stylesheet for checkout -->
    <link rel="stylesheet" href="userDetials.css">
    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="logo">NavRang</a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container" id="checkout-page">
        <div class="checkout-grid">
            <!-- Left Column: User Details & Address -->
            <div class="checkout-details-column">
                <!-- User Profile Section -->
                <div class="profile-card" id="user-details-container">
                    <!-- User details will be rendered here by JS -->
                </div>
                
                <!-- Address Section -->
                <div class="address-section-container profile-card">
                    <h2 class="section-title">Shipping Address</h2>
                    <div id="address-display">
                        <!-- Saved address will be rendered here by JS -->
                    </div>
                    <div id="address-form-container" style="display: none;">
                        <form id="addressForm">
                            <!-- Form fields now match the API documentation -->
                            <div class="form-group"><input type="text" id="building" class="form-input" placeholder="Building, Apartment, etc." required></div>
                            <div class="form-group"><input type="text" id="address" class="form-input" placeholder="Street Address" required></div>
                            <div class="form-group"><input type="text" id="nearTo" class="form-input" placeholder="Nearby Landmark (Optional)"></div>
                            <div class="form-group"><input type="text" id="pinCode" class="form-input" placeholder="Pincode" required></div>
                            <div class="form-group"><input type="text" id="city" class="form-input" placeholder="City" required></div>
                            <div class="form-group"><input type="text" id="state" class="form-input" placeholder="State" required></div>
                            <button type="submit" class="cta-primary" style="width:100%;">Save Address</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary -->
            <div class="order-summary-column">
                <div class="cart-summary" id="order-summary">
                    <!-- Order summary will be rendered here by JS -->
                </div>
            </div>
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check for login token
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                showNotification('Please log in to proceed with checkout.', 'error');
                setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                return;
            }
            
            // Initial setup
            renderUserProfile();
            renderOrderSummary();
            // Fetch and render user data, including address
            fetchUserData(authToken);
        });

        // --- USER & ADDRESS FUNCTIONS ---

        async function fetchUserData(token) {
            // NOTE: The provided API doc doesn't have a GET /user endpoint.
            // This function assumes user details (name, email) are in localStorage,
            // and we need to fetch address details separately.
            // If an endpoint to get all user data exists, it should be used here.
            
            // For now, we simulate fetching by checking localStorage.
            // A real app might have a GET /api/me or GET /api/user endpoint.
            const userAddress = JSON.parse(localStorage.getItem('userAddress'));
            if (userAddress) {
                renderAddressSection(userAddress);
            } else {
                showAddressForm(false); // Show form if no address is saved
            }
        }

        function renderUserProfile() {
            const userName = localStorage.getItem('userName');
            const userEmail = localStorage.getItem('userEmail');
            const container = document.getElementById('user-details-container');
            const userInitial = (userName?.charAt(0) || 'S').toUpperCase();
            container.innerHTML = `
                <div class="profile-avatar">${userInitial}</div>
                <h1 class="section-title" style="font-size: 1.8rem;">Confirm Details</h1>
                <div class="profile-details">
                    <p><strong>Name:</strong> <span>${userName}</span></p>
                    <p><strong>Email:</strong> <span>${userEmail}</span></p>
                </div>`;
        }

        function renderAddressSection(address) {
            const addressDisplay = document.getElementById('address-display');
            const addressFormContainer = document.getElementById('address-form-container');

            if (address && address.address) { // Check for a key field like 'address'
                addressDisplay.innerHTML = `
                    <div class="saved-address">
                        <p>${address.building}</p>
                        <p>${address.address}</p>
                        ${address.nearTo ? `<p>Near: ${address.nearTo}</p>` : ''}
                        <p>${address.city}, ${address.state} - ${address.pinCode}</p>
                    </div>
                    <button onclick="showAddressForm(true)" class="cta-primary" style="margin-top: 15px; background: var(--day6-red);">Change Address</button>
                `;
                addressDisplay.style.display = 'block';
                addressFormContainer.style.display = 'none';
            } else {
                showAddressForm(false);
            }
        }

        function showAddressForm(isEditing) {
            document.getElementById('address-display').style.display = 'none';
            document.getElementById('address-form-container').style.display = 'block';

            if (isEditing) {
                const savedAddress = JSON.parse(localStorage.getItem('userAddress'));
                if (savedAddress) {
                    document.getElementById('building').value = savedAddress.building || '';
                    document.getElementById('address').value = savedAddress.address || '';
                    document.getElementById('nearTo').value = savedAddress.nearTo || '';
                    document.getElementById('pinCode').value = savedAddress.pinCode || '';
                    document.getElementById('city').value = savedAddress.city || '';
                    document.getElementById('state').value = savedAddress.state || '';
                }
            }
        }

        document.getElementById('addressForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const authToken = localStorage.getItem('authToken');
            const addressData = {
                building: document.getElementById('building').value,
                address: document.getElementById('address').value,
                nearTo: document.getElementById('nearTo').value,
                pinCode: document.getElementById('pinCode').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
            };

            try {
                const response = await axios.patch('https://navrang-backend.onrender.com/api/update-address', addressData, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                // Save the updated address to localStorage for persistence
                const updatedUser = response.data.user;
                localStorage.setItem('userAddress', JSON.stringify(updatedUser.address));
                
                showNotification('Address saved successfully!', 'success');
                renderAddressSection(updatedUser.address);
            } catch (error) {
                const errorMessage = error.response?.data?.message || 'Failed to save address.';
                showNotification(errorMessage, 'error');
            }
        });

        // --- ORDER FUNCTIONS ---

        function renderOrderSummary() {
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            const summaryContainer = document.getElementById('order-summary');

            if (cartItems.length === 0) {
                summaryContainer.innerHTML = '<h2>Your cart is empty.</h2><p>Add items to your cart to place an order.</p>';
                return;
            }

            const subtotal = cartItems.reduce((total, item) => total + (item.quantity * item.price), 0);
            const gst = subtotal * 0.18; // 18% GST
            const grandTotal = subtotal + gst;

            summaryContainer.innerHTML = `
                <h2>Order Summary</h2>
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span>₹${subtotal.toLocaleString('en-IN')}</span>
                </div>
                <div class="summary-row">
                    <span>GST (18%)</span>
                    <span>₹${gst.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                </div>
                 <div class="summary-row">
                    <span>Shipping</span>
                    <span style="color: var(--day2-green);">Free</span>
                </div>
                <div class="summary-row total">
                    <span>Grand Total</span>
                    <span>₹${grandTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                </div>
                <button class="checkout-btn" onclick="placeOrder()">Place Order</button>
            `;
        }

        async function placeOrder() {
            const authToken = localStorage.getItem('authToken');
            const savedAddress = JSON.parse(localStorage.getItem('userAddress'));

            if (!savedAddress || !savedAddress.address) {
                showNotification('Please save a shipping address before placing your order.', 'error');
                return;
            }

            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            if (cartItems.length === 0) {
                showNotification('Your cart is empty.', 'error');
                return;
            }

            // Format cart items for the backend API
            const productDetails = cartItems.map(item => ({
                productId: item.id,
                quantity: item.quantity
            }));

            const orderData = {
                productDetails: productDetails,
                isCOD: true // Assuming Cash on Delivery
            };

            try {
                const response = await axios.post('https://navrang-backend.onrender.com/api/create-order', orderData, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                localStorage.removeItem('cartItems'); // Clear cart on successful order
                
                const mainContainer = document.getElementById('checkout-page');
                mainContainer.innerHTML = `
                    <div class="empty-cart" style="grid-column: 1 / -1; text-align: center; padding: 60px;">
                        <h2>Thank you for your order! 🙏</h2>
                        <p>Your order with ID ${response.data.orderId} has been placed. You will be redirected to the homepage shortly.</p>
                    </div>`;

                setTimeout(() => { window.location.href = 'index.html'; }, 5000);

            } catch (error) {
                const errorMessage = error.response?.data?.error || 'Failed to place order.';
                showNotification(errorMessage, 'error');
            }
        }

        // --- UTILITY FUNCTIONS ---

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.classList.add('show'); }, 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
