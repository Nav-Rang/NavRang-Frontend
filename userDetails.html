<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavRang | Checkout</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dm26lxw7u/image/upload/v1751883905/NavRang_zzk8rf.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="userDetials.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="logo">NavRang</a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container" id="checkout-page">
        <div class="checkout-grid">
            <div class="checkout-details-column">
                <h1 class="section-title"><div style="font-family:sans-serif; font-weight: bold; font-size: larger; text-align: center;">Checkout</div></h1>

                <div class="profile-card">
                    <div class="profile-details">
                        <h3>Account Holder</h3>
                        <p id="userNameDisplay">Guest User</p>
                        <p id="userEmailDisplay">guest@example.com</p>
                    </div>
                </div>

                <div class="card address-section-container">
                    <div style="font-family:sans-serif; font-weight: bold;margin-top: -15px;">Delivery Address</div>
                    <div id="savedAddress" class="saved-address" style="display:none;">
                        <p id="addressName"></p>
                        <p id="addressPhone"></p>
                        <p id="addressDetails"></p>
                        <p id="addressCityStatePin"></p>
                        <p id="addressNearTo"></p>
                    </div>
                     <p id="addressPrompt" style="display:none;">Please add your delivery address below.</p>
                    <button id="changeAddressBtn" class="auth-button" style="margin-top: 1rem; display:none;">Change Address</button>
                    
                    <form id="addressForm" class="address-form" style="display:none; margin-top: 20px;">
                         <div class="form-group">
                            <label for="phone">Enter Your Contact Number</label>
                            <input type="text" id="phone" class="form-input" placeholder="Contact Number" required>
                        </div>
                        <div class="form-group">
                            <label for="building">Building/House No.</label>
                            <input type="text" id="building" class="form-input" placeholder="Flat, House no., Building" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Street/Colony</label>
                            <input type="text" id="address" class="form-input" placeholder="Area, Colony, Street, Sector" required>
                        </div>
                        <div class="form-group">
                            <label for="nearTo">Landmark</label>
                            <input type="text" id="nearTo" class="form-input" placeholder="E.g., Near Apollo Hospital">
                        </div>
                        <div class="form-group">
                            <label for="pinCode">Pincode</label>
                            <input type="text" id="pinCode" class="form-input" placeholder="Enter Pincode" required>
                        </div>
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" class="form-input" placeholder="City" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" class="form-input" placeholder="State" required>
                        </div>
                        <button type="submit" class="auth-button">Save Address</button>
                    </form>
                </div>
                 <div class="card payment-method-card">
                    
                    <div class="payment-options">
                        <div style="font-family:sans-serif; font-weight: bold;">Payment Method</div>
                        <button id="codButton" class="payment-button">
                            <strong>Cash on Delivery</strong>
                            <span>Pay at your doorstep</span>
                        </button>
                        <button id="razorpayButton" class="payment-button">
                            <strong>Pay Online</strong>
                            <span>Cards, UPI, Netbanking via Razorpay</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="order-summary-column">
                <div class="cart-summary">
                    <h2>Order Summary</h2>
                    <div id="orderSummaryItems">
                        </div>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotalAmount">₹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>GST (18%):</span>
                        <span id="gstAmount">₹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping:</span>
                        <span><del>₹50.00</del></span></div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="totalAmount">₹0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                 <div class="footer-section">
                    <h3>NavRang</h3>
                    <p>Your Divine Shopping Destination.</p>
                </div>
                 <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a style="text-decoration: none; color:whitesmoke;" href="index.html">Home</a></li>
                        <li><a style="text-decoration: none; color:whitesmoke;" href="about.html">About Us</a></li>
                        <li><a style="text-decoration: none; color:whitesmoke;" href="contact.html">Contact</a></li>
                        <li><a style="text-decoration: none; color:whitesmoke;" href="cart.html">Cart</a></li>
                    </ul>
                </div>
                 <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p>Email: contact.us.navrang@gmail.com</p>
                    <p>Phone: +91 96194 10050</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 NavRang. All rights reserved.</p>
            </div>
        </div>
    </footer>

     <script>
        const backendUrl = 'https://navrang-backend.onrender.com/api';

        document.addEventListener('DOMContentLoaded', () => {
            const userLoggedIn = localStorage.getItem('userLoggedIn');
            if (userLoggedIn !== 'true') {
                showNotification('Please log in to proceed with checkout.', 'error');
                setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                return;
            }

            loadUserDetails();
            loadAddressDetails(); // Changed from initializeAddressSection
            renderOrderSummary();

            document.getElementById('changeAddressBtn').addEventListener('click', () => {
                const form = document.getElementById('addressForm');
                const button = document.getElementById('changeAddressBtn');
                if (form.style.display === 'none') {
                    form.style.display = 'block';
                    button.textContent = 'Hide Address Form';
                } else {
                    form.style.display = 'none';
                    button.textContent = 'Change Address';
                }
            });

            document.getElementById('addressForm').addEventListener('submit', handleSaveAddress);
            document.getElementById('codButton').addEventListener('click', handleCashOnDelivery);
            document.getElementById('razorpayButton').addEventListener('click', handleRazorpayPayment);
        });

        function displayAddress(user) {
            const address = user.address;
            const savedAddressDiv = document.getElementById('savedAddress');
            const addressForm = document.getElementById('addressForm');
            const changeAddressBtn = document.getElementById('changeAddressBtn');
            const addressPrompt = document.getElementById('addressPrompt');

            if (address && address.building) {
                document.getElementById('addressName').textContent = user.name || localStorage.getItem('userName');
                document.getElementById('addressPhone').textContent = `Phone: ${address.phone}`;
                document.getElementById('addressDetails').textContent = `${address.building}, ${address.address}`;
                document.getElementById('addressCityStatePin').textContent = `${address.city}, ${address.state} - ${address.pinCode}`;
                document.getElementById('addressNearTo').textContent = address.nearTo ? `Landmark: ${address.nearTo}` : '';
                
                // Pre-fill form for editing
                document.getElementById('phone').value = address.phone || '';
                document.getElementById('building').value = address.building || '';
                document.getElementById('address').value = address.address || '';
                document.getElementById('nearTo').value = address.nearTo || '';
                document.getElementById('pinCode').value = address.pinCode || '';
                document.getElementById('city').value = address.city || '';
                document.getElementById('state').value = address.state || '';

                savedAddressDiv.style.display = 'block';
                addressPrompt.style.display = 'none';
                addressForm.style.display = 'none';
                changeAddressBtn.style.display = 'block';
                changeAddressBtn.textContent = 'Change Address';
            } else {
                 initializeAddressSection();
            }
        }

        function initializeAddressSection() {
            document.getElementById('addressPrompt').style.display = 'block';
            document.getElementById('addressForm').style.display = 'block';
            document.getElementById('savedAddress').style.display = 'none';
            document.getElementById('changeAddressBtn').style.display = 'none';
        }

        function loadAddressDetails() {
            const savedAddressJSON = localStorage.getItem('userAddress');
            if (savedAddressJSON) {
                const address = JSON.parse(savedAddressJSON);
                const userName = localStorage.getItem('userName');
                const user = { name: userName, address: address };
                displayAddress(user);
            } else {
                initializeAddressSection();
            }
        }

        async function loadUserDetails() {
            const userName = localStorage.getItem('userName') || 'Guest';
            const userEmail = localStorage.getItem('userEmail') || 'guest@example.com';
            document.getElementById('userNameDisplay').textContent = userName;
            document.getElementById('userEmailDisplay').textContent = userEmail;
        }

        async function handleSaveAddress(event) {
            event.preventDefault();
            const token = localStorage.getItem('authToken');
            const button = event.target.querySelector('button[type="submit"]');

            const addressData = {
                phone: document.getElementById('phone').value,
                building: document.getElementById('building').value,
                address: document.getElementById('address').value,
                nearTo: document.getElementById('nearTo').value,
                pinCode: document.getElementById('pinCode').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value
            };

            setLoadingState(button, true, 'Saving...');
            try {
                const response = await axios.patch(`${backendUrl}/update-user-details`, addressData, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showNotification(response.data.message || 'Address updated successfully!', 'success');
                if (response.data.user) {
                    // Save address and name to localStorage
                    localStorage.setItem('userAddress', JSON.stringify(response.data.user.address));
                    localStorage.setItem('userName', response.data.user.name);
                    // Update UI
                    displayAddress(response.data.user);
                    loadUserDetails(); // Refresh user name in profile card
                }
            } catch (error) {
                console.error('Error saving address:', error);
                showNotification(error.response?.data?.message || 'Failed to save address.', 'error');
            } finally {
                setLoadingState(button, false, 'Save Address');
            }
        }

        function renderOrderSummary() {
            let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            const orderSummaryItemsDiv = document.getElementById('orderSummaryItems');
            orderSummaryItemsDiv.innerHTML = '';
            let subtotal = 0;

            if (cartItems.length === 0) {
                orderSummaryItemsDiv.innerHTML = '<p>Your cart is empty.</p>';
                document.getElementById('totalAmount').textContent = '₹0.00';
                document.getElementById('subtotalAmount').textContent = '₹0.00';
                return;
            }

            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'summary-row';
                itemDiv.innerHTML = `
                    <span>${item.name} (x${item.quantity})</span>
                    <span>₹${itemTotal.toFixed(2)}</span>
                `;
                orderSummaryItemsDiv.appendChild(itemDiv);
            });

            const shippingCost = 50; 
            const total = subtotal + shippingCost;

            document.getElementById('subtotalAmount').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `₹${total.toFixed(2)}`;
        }

        async function handleCashOnDelivery() {
            const codButton = document.getElementById('codButton');
            setLoadingState(codButton, true, 'Placing Order...');
            try {
                const token = localStorage.getItem('authToken');
                const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
                
                if (cartItems.length === 0) {
                    showNotification('Your cart is empty.', 'error');
                    setLoadingState(codButton, false, 'Cash on Delivery');
                    return;
                }

                const productDetails = cartItems.map(item => ({ productId: item.id, quantity: item.quantity }));

                const response = await axios.post(`${backendUrl}/create-order`, { productDetails, isCOD: true }, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                showNotification(response.data.message || 'COD Order Placed Successfully!', 'success');
                localStorage.removeItem('cartItems');
                localStorage.removeItem('userAddress'); // Clear address after order
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);

            } catch (error) {
                showNotification(error.response?.data?.error || 'Failed to place order. Please ensure your address is saved.', 'error');
            } finally {
                setLoadingState(document.getElementById('codButton'), false, '<strong>Cash on Delivery</strong><span>Pay at your doorstep</span>');
            }
        }

        async function handleRazorpayPayment() {
            const razorpayButton = document.getElementById('razorpayButton');
            setLoadingState(razorpayButton, true, 'Initiating...');

            try {
                const token = localStorage.getItem('authToken');
                const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
                
                if (cartItems.length === 0) {
                    showNotification('Your cart is empty.', 'error');
                    setLoadingState(razorpayButton, false, 'Pay with Razorpay');
                    return;
                }
                const productDetails = cartItems.map(item => ({ productId: item.id, quantity: item.quantity }));
                
                const orderResponse = await axios.post(`${backendUrl}/create-order`, { productDetails, isCOD: false }, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const { razorpayOrder, orderId } = orderResponse.data;

                var options = {
                    "key": "rzp_test_wLxVTVeMK5c4nU", 
                    "amount": razorpayOrder.amount,
                    "currency": razorpayOrder.currency,
                    "name": "NavRang",
                    "description": "Purchase from NavRang",
                    "image": "https://res.cloudinary.com/dm26lxw7u/image/upload/v1751883905/NavRang_zzk8rf.png",
                    "order_id": razorpayOrder.id,
                    "handler": async function (response) {
                        setLoadingState(razorpayButton, true, 'Verifying...');
                        try {
                            const verificationResponse = await axios.post(`${backendUrl}/verify-payment`, {
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature,
                                orderId: orderId
                            }, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            showNotification(verificationResponse.data.msg || 'Payment successful!', 'success');
                            localStorage.removeItem('cartItems');
                            localStorage.removeItem('userAddress'); // Clear address after order
                            setTimeout(() => { window.location.href = 'index.html'; }, 2000);

                        } catch (verifyError) {
                            showNotification(verifyError.response?.data?.error || 'Payment verification failed.', 'error');
                        } finally {
                             setLoadingState(document.getElementById('razorpayButton'), false, '<strong>Pay Online</strong><span>Cards, UPI, Netbanking via Razorpay</span>');
                        }
                    },
                    "prefill": {
                        "name": localStorage.getItem('userName'),
                        "email": localStorage.getItem('userEmail'),
                    },
                    "theme": { "color": "#9932CC" }
                };

                var rzp = new Razorpay(options);
                rzp.on('payment.failed', function (response){
                    showNotification(`Payment failed: ${response.error.description}.`, 'error');
                });
                rzp.open();

            } catch (error) {
                showNotification(error.response?.data?.error || 'Failed to initiate payment. Please ensure your address is saved.', 'error');
            } finally {
                 setLoadingState(document.getElementById('razorpayButton'), false, '<strong>Pay Online</strong><span>Cards, UPI, Netbanking via Razorpay</span>');
            }
        }

        function setLoadingState(button, isLoading, loadingText) {
            if (button) {
                button.disabled = isLoading;
                if(isLoading) {
                    button.innerHTML = `<span class="spinner"></span> ${loadingText}`;
                } else {
                    button.innerHTML = loadingText;
                }
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.classList.add('show'); }, 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
