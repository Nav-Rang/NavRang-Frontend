<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavRang | Sign Up</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dm26lxw7u/image/upload/v1751883905/NavRang_zzk8rf.png">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="auth.css">
    <style>
        .auth-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; }
        .tab-link { flex: 1; padding: 1rem; text-align: center; cursor: pointer; background: #f9f9f9; color: #777; font-weight: 600; border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--day9-purple); border-bottom-color: var(--day9-purple); background: white; }
        .form-container { display: none; }
        .form-container.active { display: block; }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-left">
            <img height="150px" style="border-radius: 15px;" src="https://res.cloudinary.com/dm26lxw7u/image/upload/v1751883905/NavRang_zzk8rf.png" alt="NavRang Logo">
            <h1 class="sacred-logo">NavRang</h1>
            <p class="sacred-tagline">Your Divine Shopping Destination</p>
        </div>

        <div class="auth-right">
             <div class="auth-tabs">
                <div class="tab-link active" onclick="switchTab('password')">Use Password</div>
                <div class="tab-link" onclick="switchTab('otp')">Use OTP</div>
            </div>

            <div id="password-form" class="form-container active">
                <form class="auth-form" id="signupFormPassword">
                    <div class="form-header">
                        <h2 class="form-title">Create Account</h2>
                        <p class="form-subtitle">Join with a secure password</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="name-password">Your Name</label>
                        <input type="text" id="name-password" class="form-input" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="email-password">Email Address</label>
                        <input type="email" id="email-password" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">Password</label>
                        <input type="password" id="password" class="form-input" placeholder="Create a password" required>
                    </div>
                    <button type="submit" class="auth-button" id="signupButtonPassword">Create Account</button>
                </form>
            </div>

            <div id="otp-form" class="form-container">
                 <form class="auth-form" id="signupFormOtp">
                    <div class="form-header">
                        <h2 class="form-title">OTP Signup</h2>
                        <p class="form-subtitle">Verify your email to create an account</p>
                    </div>
                    <div id="otp-details-group">
                        <div class="form-group">
                            <label class="form-label" for="name-otp">Your Name</label>
                            <input type="text" id="name-otp" class="form-input" placeholder="Enter your full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="email-otp">Email Address</label>
                            <input type="email" id="email-otp" class="form-input" placeholder="Enter your email" required>
                        </div>
                        <button type="button" class="auth-button" id="sendOtpButton">Send OTP</button>
                    </div>
                    <div class="form-group" id="otp-verify-group" style="display: none;">
                        <label class="form-label" for="otp">Enter OTP</label>
                        <input type="text" id="otp" class="form-input" placeholder="Enter 6-digit OTP" required>
                        <button type="submit" class="auth-button" id="verifyOtpButton" style="margin-top: 1rem;">Verify OTP & Create Account</button>
                    </div>
                </form>
            </div>

            <div class="form-footer">
                <p>Already have an account? <a href="login.html">Log In</a></p>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab-link[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            document.querySelectorAll('.form-container').forEach(form => form.classList.remove('active'));
            document.getElementById(`${tabName}-form`).classList.add('active');
        }

        // --- Password Signup Logic ---
        document.getElementById('signupFormPassword').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-password').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name-password').value;
            const button = document.getElementById('signupButtonPassword');

            setLoadingState(button, true, 'Creating Account...');
            try {
                const response = await axios.post('https://navrang-backend.onrender.com/api/signup', { email, name, password });
                
                showNotification(response.data.message || 'Account created successfully!', 'success');
                try {
                    const loginResponse = await axios.post('https://navrang-backend.onrender.com/api/login', { email, password });
                    handleSuccessfulLogin(loginResponse.data.token, email, name);
                } catch (loginError) {
                    console.error("Auto-login after signup failed:", loginError);
                    setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                }

            } catch (error) {
                const errorMessage = error.response?.data?.message || 'Signup failed.';
                showNotification(errorMessage, 'error');
            } finally {
                setLoadingState(button, false, 'Create Account');
            }
        });

        // --- OTP Signup Logic ---
        document.getElementById('sendOtpButton').addEventListener('click', async () => {
            const email = document.getElementById('email-otp').value;
            const name = document.getElementById('name-otp').value;
            if (!email || !name) {
                showNotification('Please enter your name and email.', 'error');
                return;
            }
            const button = document.getElementById('sendOtpButton');
            setLoadingState(button, true, 'Sending...');
            try {
                await axios.post('https://navrang-backend.onrender.com/api/sendOTP', { email });
                showNotification('OTP sent to your email!', 'success');
                document.getElementById('otp-details-group').style.display = 'none';
                document.getElementById('otp-verify-group').style.display = 'block';
            } catch (error) {
                showNotification(error.response?.data?.message || 'Failed to send OTP.', 'error');
            } finally {
                setLoadingState(button, false, 'Send OTP');
            }
        });

        document.getElementById('signupFormOtp').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-otp').value;
            const name = document.getElementById('name-otp').value;
            const otp = document.getElementById('otp').value;
            const button = document.getElementById('verifyOtpButton');

            setLoadingState(button, true, 'Verifying...');

            try {
                const verifyResponse = await axios.post('https://navrang-backend.onrender.com/api/verifyOTP', { email, otp });
                const token = verifyResponse.data.token;

                if (!token) {
                    showNotification('Verification failed, please try again.', 'error');
                    setLoadingState(button, false, 'Verify OTP & Create Account');
                    return;
                }

                handleSuccessfulLogin(token, email, name);

                try {
                    await axios.patch('https://navrang-backend.onrender.com/api/update-user-details', 
                        { email, name, phone: "" },
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );
                } catch (updateError) {
                    console.error("Post-signup name update failed:", updateError.response?.data?.message || updateError.message);
                }

            } catch (verifyError) {
                const errorMessage = verifyError.response?.data?.message || 'Invalid OTP or verification failed.';
                showNotification(errorMessage, 'error');
            } finally {
                setLoadingState(button, false, 'Verify OTP & Create Account');
            }
        });

        // --- COMMON FUNCTIONS ---
        function handleSuccessfulLogin(token, email, name) {
            localStorage.setItem('authToken', token);
            localStorage.setItem('userLoggedIn', 'true');
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userName', name);
            
            showNotification('Account created successfully! Welcome. 🕉️', 'success');
            setTimeout(() => { window.location.href = 'index.html'; }, 1500);
        }

        function setLoadingState(button, isLoading, loadingText) {
            if (button) {
                button.disabled = isLoading;
                button.innerHTML = isLoading ? `<span class="spinner"></span> ${loadingText}` : button.textContent;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.classList.add('show'); }, 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
